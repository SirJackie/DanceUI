<!DOCTYPE html>
<html>
    <head>
        <title>test</title>
        <style>
            *{
                font-size:5vh;
            }
            body{
                margin:0;
            }
            box{
                width:100px;
                display: block;
                min-height:1em;
                box-shadow:0 0 0.625em #777777;
                margin:0.625em;
                text-align:center;
                float:left;
            }
        </style>
    </head>
    <body onResize="">
        <box>hello</box>
        <box>hello</box>
        <box>hello</box>
        <box>hello</box>
        <next></next>

        <box>hello</box>
        <box>hello</box>
        <box>hello</box>
        <next></next>

        <box>hello</box>
        <box>hello</box>
        <next></next>

        <box>hello</box>
        <next></next>

        <box>
            <box>a</box>
            <box>b</box>
            <next></next>
            <box>c</box>
        </box>
        <next></next>

        <box>hello</box>
        <box>hello</box>
        <box>hello</box>
        <box>hello</box>
        <next></next>

        <box>hello</box>
        <box>hello</box>
        <box>hello</box>
        <next></next>

        <box>hello</box>
        <box>hello</box>
        <next></next>

        <box>hello</box>
        <next></next>

        <box>
            <box>a</box>
            <box>b</box>
            <next></next>
            <box>c</box>
        </box>

        <script>
            var windowWidth = window.innerWidth;
            var windowHeight = window.innerHeight;
            window.onload = function(){
                refresh();
                refresh();
                setInterval(checkWindowSize,100);
            }
            function refresh(parent){
                if(parent == undefined){
                    parent = document.getElementsByTagName("body")[0];
                }

                var childList = [];
                for(var i = 0;i<parent.childNodes.length;i++){
                    childList.push(parent.childNodes[i]);
                }
                //console.log(childList);

                var hasBoxTag = false;
                var i = 0;
                while(i<childList.length){
                    if(childList[i].tagName == "BOX"){
                        hasBoxTag = true;
                        break;
                    }
                    else{
                        i += 1;
                    }
                }

                if(!hasBoxTag){
                    return;
                }

                var boxList = [];
                var tmpArr = [];
                var nowBoxListIndex = 0;
                for(var i = 0;i<childList.length;i++){
                    if(childList[i].tagName == "BOX"){
                        tmpArr.push(childList[i]);
                    }
                    else if(childList[i].tagName == "NEXT"){
                        boxList.push(tmpArr);
                        tmpArr = [];
                        nowBoxListIndex += 1;
                    }
                }
                boxList.push(tmpArr);

                for(var j = 0;j<boxList.length;j++){
                    var parentWidth = boxList[j][0].parentNode.clientWidth;
                    //alert(parentWidth);
                    var totalFlex = 0;
                    for(var i = 0;i<boxList[j].length;i++){
                        boxList[j][i].flex = boxList[j][i].getAttribute("flex");
                        if(!boxList[j][i].flex){
                            boxList[j][i].flex = 1;
                        }
                        totalFlex += parseInt(boxList[j][i].flex);
                    }
                    //alert(totalFlex);
                    var everyFlex = parentWidth / totalFlex;
                    for(var i = 0;i<boxList[j].length;i++){
                        var boxElement = boxList[j][i];
                        var boxStyle = style = window.getComputedStyle(boxElement, null);
                        var marginLeft = boxStyle.marginLeft;
                        var marginRight = boxStyle.marginRight;
                        marginLeft = parseFloat(marginLeft.substr(0,marginLeft.length-2));
                        marginRight = parseFloat(marginRight.substr(0,marginRight.length-2));
                        boxList[j][i].style.width = Math.floor(boxList[j][i].flex * everyFlex - marginLeft - marginRight) + "px";
                    }
                }

                for(var j = 0;j<boxList.length;j++){
                    for(var i = 0;i<boxList[j].length;i++){
                        refresh(boxList[j][i]);
                    }
                }

                //console.log(boxList);
            }
            function checkWindowSize(){
                if(windowWidth != window.innerWidth || windowHeight != window.innerHeight){
                    windowWidth = window.innerWidth;
                    windowHeight = window.innerHeight;
                    refresh();
                }
            }
        </script>
    </body>
</html>